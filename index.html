<!doctype html>
<html>

<head>
    <title>Population Globe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
    body, canvas {
        margin: 0;
        padding: 0;
    }
    .display_block {
        display:block;
    }
    .center_margin {
        margin: 0 auto;
    }
    .center_text {
        text-align: center;
    }
    button {
        padding:15px;
        border: none;
        background-color: lightgrey;
    }
    .float_left {
        float:left;
    }
    .float_right {
        float:right;
    }
    #canvas {
        border:1px solid #000000;
        /*width: 100%;*/
    }
    </style>
</head>

<body>
<!--
<h1 class="display_block center_margin center_text">Population Globe</h1> -->

<canvas id="canvas" class="display_block center_margin">
</canvas>
<!-- <br>
<button class="display_block float_left" onclick="rotateLeft()">Left</button>
<button class="display_block float_right" onclick="rotateRight()">Right</button> -->

</body>

<script>
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");
var perspective = 0;
var w;
if(window.innerWidth < window.innerHeight) {
    w = window.innerWidth;
} else {
    w = window.innerHeight;
}
var hw = w / 2;
var cities = null;
var perspectiveUnit = 5;

main();

function main() {
    canvas.width = w;
    canvas.height = w;

    requestAJAX("cities3.json");
}

function rotateLeft() {
    if(perspective < 180) {
        perspective += perspectiveUnit;
    } else {
        perspective = -180 + perspectiveUnit;
    }
    drawGlobe();
}

function rotateRight() {
    if(perspective > -180+perspectiveUnit) {
        perspective -= perspectiveUnit;
    } else {
        perspective = 180;
    }
    drawGlobe();
}

function drawGlobe() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.arc(hw,hw,hw,0,2*Math.PI);
    ctx.stroke();
    drawCities();
}

function drawCities() {
    var top;
    var bottom;
    if(perspective >= 0) {
        bottom = perspective - 90;
        if(perspective + 90 <= 180) {
            top = perspective + 90;
        } else {
            top = perspective - 270
        }
    } else {
        top = perspective + 90;
        if(perspective - 90 > -180) {
            bottom = perspective - 90;
        } else {
            bottom = perspective + 270;
        }
    }
    for(var i =0;i<cities.length;i++) {
        var city = cities[i];
        var latitude = parseFloat(city.latitude.value);
        var longitude = parseFloat(city.longitude.value);
        if(longitude >= bottom) {
            if(bottom + 180 >= 180) {
                drawCoordinate(latitude, longitude - perspective);
            } else if(longitude <= top) {
                drawCoordinate(latitude, longitude - perspective);
            } else {
                // do nothing, out of view
            }
        } else if(longitude <= top) {
            if(top - 180 <= -180) {
                drawCoordinate(latitude, longitude - perspective);
            } else {
                // do nothing, out of view
            }
        } else {
            // do nothing, out of view
        }
    }
}

function drawCoordinate(latDegrees, longDegrees) {
    var latRadians = degreesToRadians(latDegrees);
    var longRadians = degreesToRadians(longDegrees);

    var latOffset = hw*Math.sin(latRadians);
    var chordLength = pythagorus(latOffset, hw);
    var longOffset = chordLength*Math.sin(longRadians);
    drawPoint(
        hw+longOffset,
        hw-latOffset,
        ctx
    );
}

function pythagorus(b, c) {
    return Math.sqrt(c*c - b*b);
}

function degreesToRadians(degrees) {
    return degrees * (Math.PI / 180);
}

function drawPoint(x, y, ctx) {
    var rectSize = 5;
    ctx.fillRect(x-(rectSize/2),y-(rectSize/2),rectSize,rectSize);
}

function allTheDots() {
    for(var i= -90;i<=90;i+= 5) {
        for(var j= -90; j<= 90; j+= 5) {
            drawCoordinate(i,j,ctx);
        }
    }
}

function requestAJAX(destination) {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            recieveAJAX(xmlhttp.responseText);
        }
    }
    xmlhttp.open("GET", destination);
    xmlhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xmlhttp.send();
}

function recieveAJAX(responseText) {
    var citiesObject = JSON.parse(responseText);
    cities = citiesObject.results.bindings;
    drawGlobe();
}

var mouseDown = false;
var mouseX = 0;
mouseObserve();
function mouseObserve() {
    var canvas = document.getElementById("canvas");

    if("ontouchstart" in window) {
        canvas.addEventListener("touchstart", function(event) {
            console.log("touch start "+event.touches[0].pageX);
            mouseDown = true;
            mouseX = event.touches[0].pageX;
        });
        canvas.addEventListener("touchmove", function(event) {
            console.log("touch move "+event.touches[0].pageX);
            if(mouseDown) {
                if(difference(mouseX,event.touches[0].pageX) > perspectiveUnit) {
                    if(mouseX > event.touches[0].pageX) {
                        rotateLeft();
                    } else {
                        rotateRight();
                    }
                    mouseX = event.touches[0].pageX;
                }
            }
        });
        canvas.addEventListener("touchend", function(event) {
            console.log("touch end");
            if(mouseDown) {
                mouseDown = false;
            }
        });
    } else {
        canvas.onmousedown = function(event) {
            mouseDown = true;
            mouseX = event.pageX;
        }
        canvas.onmousemove = function(event) {
            if(mouseDown) {
                if(difference(mouseX,event.pageX) > perspectiveUnit) {
                    if(mouseX > event.pageX) {
                        rotateLeft();
                    } else {
                        rotateRight();
                    }
                    mouseX = event.pageX;
                }
            }
        }
        canvas.onmouseup = function(event) {
            if(mouseDown) {
                mouseDown = false;
            }
        }
    }
}

function difference(a,b) {
    if(a > b) return a - b;
    else return b - a;
}

</script>

</html>
