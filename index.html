<!doctype html>
<html>

<head>
    <title>Population Globe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
    body, canvas {
        margin: 0;
        padding: 0;
    }
    .display_block {
        display:block;
    }
    .center_margin {
        margin: 0 auto;
    }
    #canvas {
        border:1px solid #000000;
    }
    </style>
</head>

<body>

<canvas id="canvas" class="display_block center_margin">
</canvas>

</body>

<script>
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");
var perspective = 0;
var w;
if(window.innerWidth < window.innerHeight) {
    w = window.innerWidth;
} else {
    w = window.innerHeight;
}
var hw = w / 2;
var cities = null;
var perspectiveUnit = 5;

var rotationQueue = []; // left is negative, right is positive
var rotating = false;

var mouseDown = false;
var mouseX = 0;

main();

function main() {
    console.log("version: 0.0.3");
    canvas.width = w;
    canvas.height = w;

    requestAJAX("cities3.json");
    mouseObserve();
}

function rotateQueue(direction) {
    if(typeof direction !== 'undefined') {
        rotationQueue.push(direction);
    }
    if(!rotating && rotationQueue.length > 0) {
        var units = 0;
        while(rotationQueue.length > 0) {
            units += rotationQueue.shift(); // left is negative, right is positive
        }
        if(units != 0) {
            rotating = true;
            rotate(units);
        }
    }
}

function rotate(units) {
    // left is negative, right is positive
    if(units > 0) { // right
        while(units > 0) {
            if(perspective > -180+perspectiveUnit) {
                perspective -= perspectiveUnit;
            } else {
                perspective = 180;
            }
            units--;
        }
    } else if(units < 0) { // left
        while(units < 0) {
            if(perspective < 180) {
                perspective += perspectiveUnit;
            } else {
                perspective = -180 + perspectiveUnit;
            }
            units++;
        }
    } else {
        return; // no need to be called with 0 units
    }

    drawGlobe();
    rotating = false;
    rotateQueue();
}

function drawGlobe() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
    ctx.arc(hw,hw,hw,0,2*Math.PI);
    ctx.stroke();
    drawCities();
}

function drawCities() {
    var top;
    var bottom;
    if(perspective >= 0) {
        bottom = perspective - 90;
        if(perspective + 90 <= 180) {
            top = perspective + 90;
        } else {
            top = perspective - 270
        }
    } else {
        top = perspective + 90;
        if(perspective - 90 > -180) {
            bottom = perspective - 90;
        } else {
            bottom = perspective + 270;
        }
    }
    for(var i =0;i<cities.length;i++) {
        var city = cities[i];
        var latitude = parseFloat(city.latitude.value);
        var longitude = parseFloat(city.longitude.value);
        if(longitude >= bottom) {
            if(bottom + 180 >= 180) {
                drawCoordinate(latitude, longitude - perspective);
            } else if(longitude <= top) {
                drawCoordinate(latitude, longitude - perspective);
            } else {
                // do nothing, out of view
            }
        } else if(longitude <= top) {
            if(top - 180 <= -180) {
                drawCoordinate(latitude, longitude - perspective);
            } else {
                // do nothing, out of view
            }
        } else {
            // do nothing, out of view
        }
    }
}

function drawCoordinate(latDegrees, longDegrees) {
    var latRadians = degreesToRadians(latDegrees);
    var longRadians = degreesToRadians(longDegrees);

    var latOffset = hw*Math.sin(latRadians);
    var chordLength = pythagorus(latOffset, hw);
    var longOffset = chordLength*Math.sin(longRadians);
    drawPoint(
        hw+longOffset,
        hw-latOffset,
        ctx
    );
}

function pythagorus(b, c) {
    return Math.sqrt(c*c - b*b);
}

function degreesToRadians(degrees) {
    return degrees * (Math.PI / 180);
}

function drawPoint(x, y, ctx) {
    var rectSize = 5;
    ctx.fillRect(x-(rectSize/2),y-(rectSize/2),rectSize,rectSize);
}

function allTheDots() {
    for(var i= -90;i<=90;i+= 5) {
        for(var j= -90; j<= 90; j+= 5) {
            drawCoordinate(i,j,ctx);
        }
    }
}

function requestAJAX(destination) {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            recieveAJAX(xmlhttp.responseText);
        }
    }
    xmlhttp.open("GET", destination);
    xmlhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xmlhttp.send();
}

function recieveAJAX(responseText) {
    var citiesObject = JSON.parse(responseText);
    cities = citiesObject.results.bindings;
    drawGlobe();
}


function mouseObserve() {
    var canvas = document.getElementById("canvas");

    if("ontouchstart" in window) {
        canvas.addEventListener("touchstart", function(event) {
            mouseDown = true;
            mouseX = event.touches[0].pageX;
        });
        canvas.addEventListener("touchmove", function(event) {
            event.preventDefault();
            if(mouseDown) {
                if(difference(mouseX,event.touches[0].pageX) > perspectiveUnit) {
                    if(mouseX > event.touches[0].pageX) {
                        rotateQueue(-3);
                    } else {
                        rotateQueue(3);
                    }
                    mouseX = event.touches[0].pageX;
                }
            }
        });
        canvas.addEventListener("touchend", function(event) {
            if(mouseDown) {
                mouseDown = false;
            }
        });
    } else {
        canvas.onmousedown = function(event) {
            mouseDown = true;
            mouseX = event.pageX;
        }
        canvas.onmousemove = function(event) {
            if(mouseDown) {
                if(difference(mouseX,event.pageX) > perspectiveUnit) {
                    if(mouseX > event.pageX) {
                        rotateQueue(-1);
                    } else {
                        rotateQueue(1);
                    }
                    mouseX = event.pageX;
                }
            }
        }
        canvas.onmouseup = function(event) {
            if(mouseDown) {
                mouseDown = false;
            }
        }
    }
}

function difference(a,b) {
    if(a > b) return a - b;
    else return b - a;
}

</script>

</html>
